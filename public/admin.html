<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Maishipro</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Tombol Menu Admin 4 Kolom */
        .admin-menu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid #eee;
        }
        .admin-menu-btn {
            background: #f0f4f8;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            padding: 10px 5px;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            color: #205081;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .admin-menu-btn.active {
            background: #205081;
            color: white;
            border-color: #205081;
        }
        .admin-menu-btn i { font-size: 16px; }

        /* User Card List Style */
        .user-card-list {
            padding: 15px;
            padding-bottom: 80px;
        }
        .user-card-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        .uc-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            border-bottom: 1px dashed #f0f0f0;
            padding-bottom: 5px;
        }
        .uc-label { color: #888; }
        .uc-val { font-weight: bold; color: #333; text-align: right; max-width: 65%; word-wrap: break-word;}
        
        .uc-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-uc {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn-uc-del { background: #e74c3c; }
        .btn-uc-edit { background: #f39c12; }

        /* Modal Edit User */
        .edit-modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .edit-box {
            background: white; width: 85%; padding: 20px; border-radius: 10px;
        }
        .edit-input {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 5px;
        }

        /* Empty State */
        .empty-view {
            text-align: center; padding: 50px 20px; color: #999;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="admin-page" class="page-section active">
            <header class="header">
                <div class="top-bar">
                    <div class="logo"><i class="fas fa-user-shield"></i> Admin Panel</div>
                </div>
            </header>

            <div class="admin-menu-grid">
                <div class="admin-menu-btn active" onclick="loadAdminView('list-user', this)">
                    <i class="fas fa-users"></i> List User
                </div>
                <div class="admin-menu-btn" onclick="loadAdminView('verifikasi', this)">
                    <i class="fas fa-check-circle"></i> Verifikasi
                </div>
                <div class="admin-menu-btn" onclick="loadAdminView('chat', this)">
                    <i class="fas fa-comments"></i> Chat
                </div>
                <div class="admin-menu-btn" onclick="loadAdminView('acc', this)">
                    <i class="fas fa-tasks"></i> ACC
                </div>
            </div>

            <div id="admin-content-area">
                <div id="view-list-user" class="user-card-list">Loading data...</div>
                
                <div id="view-verifikasi" class="empty-view" style="display:none;">
                    <i class="fas fa-check-double" style="font-size:40px; margin-bottom:10px;"></i>
                    <p>Halaman Verifikasi Kosong</p>
                </div>
                
                <div id="view-chat" class="empty-view" style="display:none;">
                    <i class="fas fa-comment-slash" style="font-size:40px; margin-bottom:10px;"></i>
                    <p>Belum ada Chat masuk</p>
                </div>
                
                <div id="view-acc" class="empty-view" style="display:none;">
                    <i class="fas fa-clipboard-list" style="font-size:40px; margin-bottom:10px;"></i>
                    <p>Tidak ada permintaan ACC</p>
                </div>
            </div>
        </div>

        <div id="profile-page" class="page-section">
            <header class="header">
                <div class="top-bar"><div class="logo">Profil Admin</div></div>
            </header>
            <div id="profile-content" class="dynamic-content"></div>
        </div>

        <div id="pengaturan-page" class="page-section">
            <header class="header">
                <div class="top-bar"><div class="logo">Edit Admin Info</div></div>
            </header>
            <div id="pengaturan-content" class="dynamic-content"></div>
        </div>

        <nav class="bottom-navbar">
            <div class="nav-item" onclick="window.location.href='index.html'">
                <i class="fas fa-sign-out-alt"></i><span>Web Utama</span>
            </div>
            
            <div class="nav-item active" id="nav-admin" onclick="switchAdminTab('admin')">
                <i class="fas fa-font" style="font-family: serif; font-weight: bold; font-size: 20px;"></i>
                <span>Admin</span>
            </div>

            <div class="nav-item center-item" id="nav-profile" onclick="switchAdminTab('profile')">
                <div class="floating-circle" id="nav-img-circle">
                   </div>
                <span>Profile</span>
            </div>

            <div class="nav-item" id="nav-pengaturan" onclick="switchAdminTab('pengaturan')">
                <i class="fas fa-cog"></i><span>Settings</span>
            </div>
        </nav>

    </div>

    <div id="editUserModal" class="edit-modal">
        <div class="edit-box">
            <h3>Edit User</h3>
            <input type="hidden" id="editId">
            <input type="text" id="editUser" class="edit-input" placeholder="Username">
            <input type="text" id="editEmail" class="edit-input" placeholder="Email">
            <input type="text" id="editPhone" class="edit-input" placeholder="Phone">
            <input type="text" id="editPass" class="edit-input" placeholder="Password">
            <div style="display:flex; gap:10px;">
                <button onclick="closeEditModal()" class="btn-uc btn-uc-del">Batal</button>
                <button onclick="saveEditUser()" class="btn-uc btn-uc-edit">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "/api";
        let adminData = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            loadUsers(); // Load list user saat pertama buka
        });

        // 1. CEK APAKAH YANG MASUK ADMIN?
        function checkAdminAuth() {
            const userSession = localStorage.getItem('user');
            if (!userSession) {
                alert("Anda belum login!");
                window.location.href = 'index.html';
                return;
            }
            
            adminData = JSON.parse(userSession);
            
            // Cek role manual (misal kita anggap username 'admin' atau role khusus)
            // Di sini kita percayakan backend, tapi untuk UI kita render info admin
            renderAdminProfile();
            renderAdminSettings();
        }

        // 2. NAVIGASI TAB BAWAH
        function switchAdminTab(tabName) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(tabName + '-page').classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + tabName).classList.add('active');
        }

        // 3. LOGIKA HALAMAN ADMIN (4 TOMBOL)
        function loadAdminView(viewName, btnElement) {
            // Hide semua view
            document.getElementById('view-list-user').style.display = 'none';
            document.getElementById('view-verifikasi').style.display = 'none';
            document.getElementById('view-chat').style.display = 'none';
            document.getElementById('view-acc').style.display = 'none';

            // Show selected view
            document.getElementById('view-' + viewName).style.display = 'block';

            // Active Class Button
            if(btnElement) {
                document.querySelectorAll('.admin-menu-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            if(viewName === 'list-user') {
                loadUsers();
            }
        }

        // 4. FETCH LIST USER DARI DATABASE
        async function loadUsers() {
            const container = document.getElementById('view-list-user');
            container.innerHTML = '<p style="text-align:center;">Mengambil data database...</p>';

            try {
                const res = await fetch('/api/users');
                const result = await res.json();
                
                if(result.success) {
                    let html = '';
                    result.data.forEach(user => {
                        const dateReg = new Date(user.createdAt).toLocaleDateString('id-ID');
                        // Tampilkan Password (Hati-hati, ini permintaan user, tapi tidak aman untuk production)
                        html += `
                        <div class="user-card-item">
                            <div class="uc-row"><span class="uc-label">Username</span><span class="uc-val">${user.username}</span></div>
                            <div class="uc-row"><span class="uc-label">Email</span><span class="uc-val">${user.email}</span></div>
                            <div class="uc-row"><span class="uc-label">No. HP</span><span class="uc-val">${user.phone}</span></div>
                            <div class="uc-row"><span class="uc-label">Password</span><span class="uc-val" style="color:red;">${user.password}</span></div>
                            <div class="uc-row"><span class="uc-label">Tgl Daftar</span><span class="uc-val">${dateReg}</span></div>
                            
                            <div class="uc-actions">
                                <button class="btn-uc btn-uc-edit" onclick='openEditModal(${JSON.stringify(user)})'>Edit</button>
                                <button class="btn-uc btn-uc-del" onclick="deleteUser('${user._id}')">Hapus</button>
                            </div>
                        </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>Gagal mengambil data.</p>';
                }
            } catch (e) {
                container.innerHTML = '<p>Error koneksi server.</p>';
            }
        }

        // 5. FUNGSI HAPUS USER
        async function deleteUser(id) {
            if(!confirm("Yakin hapus user ini permanen?")) return;
            
            try {
                const res = await fetch('/api/users', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if(data.success) {
                    alert("User dihapus");
                    loadUsers();
                } else {
                    alert("Gagal hapus");
                }
            } catch(e) { alert("Error server"); }
        }

        // 6. FUNGSI EDIT USER (Modal & Save)
        function openEditModal(user) {
            document.getElementById('editId').value = user._id;
            document.getElementById('editUser').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editPhone').value = user.phone;
            document.getElementById('editPass').value = user.password;
            document.getElementById('editUserModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function saveEditUser() {
            const id = document.getElementById('editId').value;
            const body = {
                id: id,
                username: document.getElementById('editUser').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                password: document.getElementById('editPass').value
            };

            const res = await fetch('/api/users', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            
            const data = await res.json();
            if(data.success) {
                alert("Data user diupdate!");
                closeEditModal();
                loadUsers();
            } else {
                alert("Gagal update.");
            }
        }

        // 7. RENDER PROFIL ADMIN (Ubah level jadi 'Admin Website')
        function renderAdminProfile() {
            const profileContent = document.getElementById('profile-content');
            const navImg = document.getElementById('nav-img-circle');
            
            // Gambar Profil Navbar
            let imgTag = `<div style="width:100%; height:100%; background:#205081; color:white; display:flex; align-items:center; justify-content:center; border-radius:50%; font-weight:bold;">A</div>`;
            if(adminData.profilePic) {
                imgTag = `<img src="${adminData.profilePic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
            }
            navImg.innerHTML = imgTag;

            // Konten Halaman Profil
            profileContent.innerHTML = `
                <div class="profile-view-header">
                    <div class="profile-view-avatar">${adminData.profilePic ? `<img src="${adminData.profilePic}" style="width:100%; height:100%; border-radius:50%;">` : 'A'}</div>
                    <div style="color:white; margin-top:10px; font-weight:bold;">${adminData.username}</div>
                    <div style="color:#dbeafe; font-size:12px; margin-top:2px;">MASTER ADMIN</div>
                </div>
                
                <div class="profile-details-card">
                    <div class="detail-row">
                        <span class="detail-label">Username</span>
                        <span class="detail-value">${adminData.username}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Email</span>
                        <span class="detail-value">${adminData.email}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status</span>
                        <span class="level-badge" style="background:#e74c3c; color:white;">ADMIN WEBSITE</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Akses</span>
                        <span class="level-badge" style="background:#205081; color:white;">FULL CONTROL</span>
                    </div>
                </div>
            `;
        }

        // 8. RENDER SETTINGS ADMIN (Full Edit)
        function renderAdminSettings() {
            const setContent = document.getElementById('pengaturan-content');
            setContent.innerHTML = `
                <div class="settings-page-wrapper">
                    <div class="form-container" style="padding: 20px 10px;">
                        <div style="text-align:center; margin-bottom:20px; color:#205081; font-weight:bold;">
                            Edit Informasi Admin
                        </div>

                        <input type="hidden" id="selfId" value="${adminData._id}">

                        <div class="form-group-styled">
                            <label class="form-label">Username</label>
                            <input type="text" id="selfUser" class="form-input-styled" value="${adminData.username}">
                        </div>

                        <div class="form-group-styled">
                            <label class="form-label">Email</label>
                            <input type="text" id="selfEmail" class="form-input-styled" value="${adminData.email}">
                        </div>

                        <div class="form-group-styled">
                            <label class="form-label">No. WhatsApp</label>
                            <input type="text" id="selfPhone" class="form-input-styled" value="${adminData.phone}">
                        </div>

                        <div class="form-group-styled">
                            <label class="form-label">Password</label>
                            <input type="text" id="selfPass" class="form-input-styled" value="${adminData.password}">
                        </div>

                        <button class="btn-auth-action" onclick="updateAdminSelf()">SIMPAN PERUBAHAN</button>
                    </div>

                    <div class="logout-area" style="padding: 0 10px;">
                        <button class="btn-logout-bottom" onclick="localStorage.removeItem('user'); window.location.href='index.html';">
                            <i class="fas fa-sign-out-alt"></i> KELUAR ADMIN
                        </button>
                    </div>
                </div>
            `;
        }

        async function updateAdminSelf() {
            const body = {
                id: document.getElementById('selfId').value, // _id user dari localStorage tidak ada di object standar login kamu?
                // CATATAN: Pastikan saat login, backend mengirim _id juga. Jika tidak, tambahkan di api/login.js
                // Jika userSession tidak punya _id, kita harus cari by email.
                // Asumsi backend login kamu mengirim data lengkap. Jika tidak, kamu harus update api/login.js
                
                username: document.getElementById('selfUser').value,
                email: document.getElementById('selfEmail').value,
                phone: document.getElementById('selfPhone').value,
                password: document.getElementById('selfPass').value
            };

            // Karena kita belum punya _id di localStorage (biasanya), kita perlu ambil _id dari response GET /api/users filter by email
            // TAPI untuk amannya, lebih baik kamu update api/login.js untuk return _id juga.
            // Untuk sekarang, kita gunakan endpoint PUT users yang sudah kita buat.
            
            // Kita coba fetch PUT
            try {
                // Kita butuh ID. Di file index.js login api kamu:
                // res.json({ userData: { username, email... } }); -> _id BELUM DIKIRIM.
                // Kamu harus edit api/index.js sedikit agar mengirim _id.
                
                // JIKA KAMU BELUM EDIT BACKEND LOGIN:
                // Gunakan pencarian manual di array users (karena admin sudah load list users)
                const resList = await fetch('/api/users');
                const dataList = await resList.json();
                const myData = dataList.data.find(u => u.email === adminData.email);
                
                if(myData) {
                    body.id = myData._id; // Dapat ID nya
                    
                    const res = await fetch('/api/users', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(body)
                    });
                    const resJson = await res.json();
                    if(resJson.success) {
                        alert("Data Admin Berhasil Diubah! Silakan Login Ulang.");
                        localStorage.removeItem('user');
                        window.location.href = 'index.html';
                    }
                }
            } catch(e) { alert("Gagal update profile"); }
        }

    </script>
</body>
</html>
